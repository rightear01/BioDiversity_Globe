<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IUCN Red List API Example</title>

  <style>
    /* 로딩 스피너 스타일 */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    body {
      margin: 0;
    }
  </style>
  <script src="//unpkg.com/d3"></script>

  <script src="//unpkg.com/globe.gl"></script>
  <!--<script src="../../dist/globe.gl.js"></script>-->
</head>

<body>

  <h1>IUCN Red List API Example</h1>

  <!-- 나라이름 -->
  <label for="countryInput">나라 이름 입력:</label>
  <input type="text" id="countryInput" placeholder="예: lion">

  <!-- 종 이름을 입력할 수 있는 텍스트 상자와 검색 버튼 -->
  <label for="speciesInput">종 이름 입력:</label>
  <input type="text" id="speciesInput" placeholder="예: lion">
  <button onclick="fetchRedListData()">검색</button>

  <!-- 로딩 스피너와 결과를 표시할 div -->
  <div id="loading" class="loader" style="display: none;"></div>

  <!-- 결과를 표시할 div -->
  <div id="result"></div>
  <div id="result_countries"></div>
  <div id="globeViz"></div>
  <script>
    
    const colorScale = d3.scaleSequentialSqrt(d3.interpolateYlOrRd);

    // GDP per capita (avoiding countries with small pop)
    const getVal = feat => feat.properties.GDP_MD_EST / Math.max(1e5, feat.properties.POP_EST);// gdp 인구에 따른 색상


    fetch('../datasets/ne_110m_admin_0_countries.geojson').then(res => res.json()).then(countries => {
      const maxVal = Math.max(...countries.features.map(getVal));
      colorScale.domain([0, maxVal]);

      const world = Globe()
        .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
        .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
        .lineHoverPrecision(0)
        .polygonsData(countries.features.filter(d => d.properties.ISO_A2 !== 'AQ')) // Antarctica를 제외
        .polygonAltitude(0.06) // 시작 기둥 높이
        .polygonCapColor(feat => colorScale(getVal(feat)))
        .polygonSideColor(() => 'rgba(0, 100, 0, 0.15)') //다각형 옆면 색상 (기둥)
        .polygonStrokeColor(() => '#000') // 경계선 색상
        .polygonLabel(({ properties: d }) => `
      <b style="color: red;">${d.ADMIN} (${d.ISO_A2}):</b> <br />
      GDP: <i style="color: red;">${d.GDP_MD_EST}</i> M$<br/>
      Population: <i style="color: red;">${d.POP_EST}</i>
    `)
        .onPolygonHover(hoverD => world
          .polygonAltitude(d => d === hoverD ? 0.12 : 0.06)
            .polygonCapColor(d => d === hoverD ? 'green' : colorScale(getVal(d)))
        )
        .polygonsTransitionDuration(300)
        (document.getElementById('globeViz'))
      // 사용자 입력을 받을 input 요소 추가
      const inputElement = document.getElementById('countryInput');

      // 사용자가 입력한 국가명에 해당하는 다각형을 찾아 높이를 조절하는 함수
      function highlightCountryByName(countryName) {
        const matchingCountry = countries.features.find(d => d.properties.ADMIN.toLowerCase() === countryName.toLowerCase());

        if (matchingCountry) {
          world.polygonAltitude(d => d === matchingCountry ? 0.12 : 0.06);
          world.polygonCapColor(d => d === matchingCountry ? 'steelblue' : colorScale(getVal(d)));
        } else {
          // 국가를 찾지 못한 경우 기본 설정으로 돌아감
          world.polygonAltitude(0.06);
          world.polygonCapColor(feat => colorScale(getVal(feat)));
        }
      }

      // 입력값이 변경될 때마다 호출되는 이벤트 리스너 추가
      inputElement.addEventListener('input', (event) => {
        const userInput = event.target.value;
        console.log(userInput);
        highlightCountryByName(userInput);
      });
    });

    async function fetchRedListData() {
      try {
        const apiKey = '9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee'; // 여기에 실제 API 키를 입력해주세요
        const speciesInput = document.getElementById('speciesInput').value;

        // 입력값이 비어있는지 확인
        if (!speciesInput) {
          alert('종 이름을 입력해주세요.');
          return;
        }
        // 로딩 스피너 표시
        document.getElementById('loading').style.display = 'block';

        // IUCN Red List API에 요청을 보냄
        const response = await fetch(`https://apiv3.iucnredlist.org/api/v3/species/${encodeURIComponent(speciesInput)}?token=${apiKey}`);
        const response_countries = await fetch(`https://apiv3.iucnredlist.org/api/v3/species/countries/name/${encodeURIComponent(speciesInput)}?token=${apiKey}`);

        // 로딩 스피너 숨기기
        document.getElementById('loading').style.display = 'none';

        // 요청이 성공적인지 확인 (상태 코드 200)
        if (response.ok) {
          const data = await response.json();
          displayResult(data);
        } else {
          const errorMessage = `에러: ${response.status} - ${response.statusText}`;
          displayResult({ error: errorMessage });
        }

        if (response_countries.ok) {
          const data = await response_countries.json();
          displayResultCountries(extractCountryNames(data));
        } else {
          const errorMessage = `에러: ${response_countries.status} - ${response_countries.statusText}`;
          displayResultCountries({ error: errorMessage });
        }
      } catch (error) {
        console.error('데이터를 불러오는 중 에러 발생:', error);
        displayResult({ error: '데이터를 불러오는 중 에러가 발생했습니다.' });
      }
    }

    // Red List 데이터를 화면에 표시하는 함수
    function displayResult(data) {
      const resultContainer = document.getElementById('result');

      // 이전 결과를 지움
      resultContainer.innerHTML = '';

      if (data.error) {
        // 에러 메시지 표시
        resultContainer.textContent = data.error;
      } else {
        // Red List 데이터 표시
        const speciesData = data.result[0];
        const commonName = speciesData.main_common_name;
        const status = speciesData.category;

        const resultText = `종: ${commonName}\n위험도: ${status}`;

        resultContainer.textContent = resultText;
      }
    }
    // 국가 이름만 추출하는 함수
    function extractCountryNames(apiResponse) {
      return apiResponse.result.map(countryInfo => countryInfo.country);
    }
    // 결과를 화면에 표시하는 함수
    function displayResultCountries(countryNames) {
      const resultContainer = document.getElementById('result_countries');

      // 이전 결과를 지움
      resultContainer.innerHTML = '';

      // 국가 이름을 결과 div에 추가
      if (countryNames.length > 0) {
        const resultText = `이 동물은 다음 국가에서 발견됩니다: ${countryNames.join(', ')}`;
        const resultTextNode = document.createTextNode(resultText);
        resultContainer.appendChild(resultTextNode);
      } else {
        const resultTextNode = document.createTextNode('국가 정보를 가져올 수 없습니다.');
        resultContainer.appendChild(resultTextNode);
      }
    }

  </script>

</body>

</html>